---
title: " Global Terrorism Database - Notebook"
author: "Simon Garnier"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    css: custom.css
    fig_caption: true
    fig_width: 8
    number_sections: true
    theme: cosmo
    toc: true
    csl: plos.csl
    bibliography: library.bib
---

--- 

# Environment setup

```{r, 'setup', message=FALSE}
library(data.table)
library(dplyr)
library(ggmap)
library(graphZoo)
library(RColorBrewer)
library(animation)
library(scales)

cbf <- brewer.pal(8, "Dark2") # A colorblind friendly palette
```

[Back to top]("#")

---

# Data loading

```{r, 'data', cache=TRUE}
select_cols <- c(1:4, 8:12, 14:15, 27, 29:30, 35:36, 41:42, 59, 81:82, 98, 101)
col_class <- rep("NULL", 134)
col_class[select_cols] <- NA

gtd <- as.data.table(
  read.csv("../data/globalterrorismdb_0814dist.csv", 
           colClasses = col_class)) %>%
  mutate(idate = ISOdate(iyear, imonth, iday))
```

[Back to top]("#")

---

# Attacks by country (TOP 50)

```{r, 'figure_1', cache=TRUE, dpi=300, fig.height=9, fig.width=6}
attacks <- group_by(gtd, country_txt) %>%
  summarize(number = length(eventid)) %>%
  ungroup() %>%
  mutate(rank = rank(-number))

g <- ggplot(filter(attacks, rank < 51), 
            aes(x = reorder(country_txt, number), y = number)) +
  geom_bar(stat = "identity", color = "white", fill = cbf[2]) + 
  coord_flip() + 
  ggtitle(bquote(atop("Terrorist attacks by country",
                      atop("since 1970")))) + 
  ylab("Number of events") + 
  theme_graphzoo(base_size = 13, family = "Avenir Next") +
  theme(axis.title.y = element_blank())

g <- addBanner(g, font.size = 3, heights = c(1, 0.05*6/9),
          l.txt = "GRAPHZOO.TUMBLR.COM", 
          r.txt = "SOURCE: GLOBAL TERRORISM DATABASE")

g
```
<p class="caption">**Figure 1:** Number of terrorist attacks by country according to the Global Terrorism Database.</p>

[Back to top]("#")

---

# Casualties by country (TOP 50)

```{r, 'figure_2', cache=TRUE, dpi=300, fig.height=9, fig.width=6}
casualties <- group_by(gtd, country_txt) %>%
  summarize(number = sum(nkill, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(rank = rank(-number))

g <- ggplot(filter(casualties, rank < 51), 
            aes(x = reorder(country_txt, number), y = number)) +
  geom_bar(stat = "identity", color = "white", fill = cbf[2]) + 
  coord_flip() + 
  ggtitle(bquote(atop("Terrorist attacks by country",
                      atop("since 1970")))) + 
  ylab("Number of casualties") + 
  theme_graphzoo(base_size = 13, family = "Avenir Next") +
  theme(axis.title.y = element_blank())

g <- addBanner(g, font.size = 3, heights = c(1, 0.05*6/9),
          l.txt = "GRAPHZOO.TUMBLR.COM", 
          r.txt = "SOURCE: GLOBAL TERRORISM DATABASE")

g
```
<p class="caption">**Figure 2:** Total number of casualties resulting from terrorist attacks by country according to the Global Terrorism Database.</p>

[Back to top]("#")

---

# Locations of terrorist attacks

```{r, 'figure_3', warning=FALSE, message=FALSE, results='asis'}
gtd_2000 <- filter(gtd, iyear > 1999) %>%
  mutate(nkill = replace(nkill, is.na(nkill), 0),
         nwound = replace(nwound, is.na(nwound), 0)) %>%
  mutate(nvic = nkill + nwound)

vic <- group_by(gtd_2000, idate) %>%
  summarize(count = sum(nvic)) %>%
  arrange(idate) %>%
  mutate(cum_count = cumsum(count))

start <- seq(ISOdate(2000, 1, 1), max(gtd_2000$idate, na.rm = TRUE), by = "1 week")
end <- seq(ISOdate(2000, 1, 8), max(gtd_2000$idate, na.rm = TRUE), by = "1 week")

base <- ggplot() + 
  borders("world", colour = "gray50") + 
  coord_fixed() + 
  theme_minimal(base_size = 18) + 
  theme(legend.position = "top",
        axis.line = element_blank(), 
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) 

ani.options(ani.height = 1024*6/10, ani.width = 1024, 
            interval = 1/12, loop = FALSE)

if (!file.exists("notebook_files/figure-html/figure_3.mp4")) {
  saveVideo({
    for (i in 1:length(end)) {
      tmp1 <- filter(gtd_2000, idate >= start[i] & idate < end[i])
      tmp2 <- filter(gtd_2000, idate < end[i])
      
      g <- base + 
        geom_point(data = tmp1, aes(x = longitude, y = latitude, size = nvic), color = "dodgerblue4") +
        geom_point(data = tmp2, aes(x = longitude, y = latitude, size = nvic), color = "tomato3", alpha = 0.1) +
        annotate("text", x = -157, y = 12, label = format(start[i], "%Y-%m-%d")) +     
        scale_size_continuous(name = "Victims (deaths and injuries)",
                              limits = c(0, max(gtd_2000$nvic, na.rm = TRUE)),
                              range = c(2, 12), 
                              breaks = seq(0, 1250, 250),
                              labels = paste0("â‰¥ ", seq(0, 1250, 250), "   "))
      
      g <- addBanner(g, font.size = 6, heights = c(1, 0.04*10/6),
                     l.txt = "GRAPHZOO.TUMBLR.COM", 
                     r.txt = "SOURCE: GLOBAL TERRORISM DATABASE")
      
      ins <- ggplot(filter(vic, idate < end[i]), 
                    aes(x = idate, y = cum_count)) +
        geom_line(size = 2, color = "dodgerblue4") + 
        geom_line(data = vic, size = 2, color = "tomato3", alpha = 0.1) +
        xlim(start[1], end[length(end)]) + 
        theme_minimal(base_size = 14) +
        xlab(NULL) + 
        scale_y_continuous(name = "Total number of victims", labels = comma,
                           limits = c(0, max(vic$cum_count)))
      
      grid.newpage()
      print(g, vp = viewport(width = 1, height = 1, x = 0.5, y = 0.5)) 
      print(ins, vp = viewport(width = 0.3, height = 0.3, x = 0.01, y = 0.4, just = "left"))      
      }
    }, 
    video.name = "notebook_files/figure-html/figure_3.mp4", 
    other.opts = "-c:v libx264 -preset slow -crf 18 -c:a copy -pix_fmt yuv420p")
}

cat("<video controls><source src='notebook_files/figure-html/figure_3.mp4' type='video/mp4'>Your browser does not support the video tag.</video>")
```
<p class="caption">**Figure 3: Weekly locations of all terrorist attacks since January 2000.** </p>

[Back to top]("#")

---
